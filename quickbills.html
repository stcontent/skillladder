<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QuickBill</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { margin-top: 0; }
input, button, textarea { margin: 5px 0; padding: 5px; width: 300px; }
button { width: 150px; }
.container { max-width: 800px; margin: auto; }
.hidden { display: none; }
table { border-collapse: collapse; width: 100%; margin: 10px 0; }
th, td { border: 1px solid #999; padding: 5px; text-align: left; }
.num { text-align: right; }
</style>
</head>
<body>
<div class="container">

<h2>QuickBill</h2>

<div id="signupDiv">
  <h3>Signup</h3>
  <input type="email" id="signupEmail" placeholder="Email"><br>
  <button onclick="sendSignupCode()">Send Code</button><br>
  <input type="text" id="signupCode" placeholder="Enter Code"><br>
  <button onclick="verifySignupCode()">Verify & Signup</button>
</div>

<div id="loginDiv" class="hidden">
  <h3>Login</h3>
  <input type="email" id="loginEmail" placeholder="Email"><br>
  <button onclick="sendLoginCode()">Send Code</button><br>
  <input type="text" id="loginCode" placeholder="Enter Code"><br>
  <button onclick="verifyLoginCode()">Verify & Login</button>
</div>

<div id="profileDiv" class="hidden">
  <h3>Profile</h3>
  <input type="text" id="shopName" placeholder="Shop Name"><br>
  <input type="text" id="contact" placeholder="Contact Info"><br>
  <input type="text" id="address" placeholder="Address"><br>
  <input type="text" id="currency" placeholder="Currency (e.g., $)"><br>
  <input type="text" id="signature" placeholder="Signature"><br>
  <button onclick="saveProfile()">Save Profile</button>
  <button onclick="loadProfile()">Load Profile</button>
</div>

<div id="invoiceDiv" class="hidden">
  <h3>Create Invoice</h3>
  Customer Name: <input type="text" id="customerName" placeholder="Customer Name"><br>
  <table id="itemsTable">
    <thead>
      <tr><th>#</th><th>Item</th><th>Qty</th><th>Rate</th><th>Discount</th><th>Discount Type</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addItemRow()">Add Item</button><br>
  <button onclick="previewInvoice()">Preview Invoice</button>
  <button onclick="generateInvoicePDF()">Generate PDF</button>
  <div id="invoicePreview"></div>
</div>

</div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxUaDpqVGqX8DhW1RnRUDJNoKmUe3gIBp0tt3CvKkbOPJzcJ34kLm76ED2Om-ve8C97sQ/exec';
let currentEmail = '';

function postAction(action, payload={}) {
  payload.action = action;
  return fetch(WEBAPP_URL, {
    method:'POST',
    body: JSON.stringify(payload),
    headers:{ 'Content-Type':'application/json' }
  }).then(r=>r.json());
}

/* ------------------- Signup/Login ------------------- */
function sendSignupCode(){
  const email = document.getElementById('signupEmail').value.trim();
  if(!email){ alert('Enter email'); return; }
  postAction('sendSignupCode',{email}).then(res=>alert(res.message));
}

function verifySignupCode(){
  const email = document.getElementById('signupEmail').value.trim();
  const code = document.getElementById('signupCode').value.trim();
  postAction('verifySignupCode',{email,code}).then(res=>{
    alert(res.message);
    if(res.success){
      currentEmail = email;
      document.getElementById('signupDiv').classList.add('hidden');
      document.getElementById('profileDiv').classList.remove('hidden');
      document.getElementById('invoiceDiv').classList.remove('hidden');
    }
  });
}

function sendLoginCode(){
  const email = document.getElementById('loginEmail').value.trim();
  if(!email){ alert('Enter email'); return; }
  postAction('sendLoginCode',{email}).then(res=>alert(res.message));
}

function verifyLoginCode(){
  const email = document.getElementById('loginEmail').value.trim();
  const code = document.getElementById('loginCode').value.trim();
  postAction('verifyLoginCode',{email,code}).then(res=>{
    alert(res.message);
    if(res.success){
      currentEmail = email;
      document.getElementById('loginDiv').classList.add('hidden');
      document.getElementById('profileDiv').classList.remove('hidden');
      document.getElementById('invoiceDiv').classList.remove('hidden');
    }
  });
}

/* ------------------- Profile ------------------- */
function saveProfile(){
  const profile = {
    shopName: document.getElementById('shopName').value,
    contact: document.getElementById('contact').value,
    address: document.getElementById('address').value,
    currency: document.getElementById('currency').value,
    signature: document.getElementById('signature').value
  };
  postAction('saveProfile',{email:currentEmail,profile}).then(res=>{
    alert(res.message);
  });
}

function loadProfile(){
  postAction('loadProfile',{email:currentEmail}).then(res=>{
    if(res.success){
      const p = res.profile;
      document.getElementById('shopName').value=p.shopName||'';
      document.getElementById('contact').value=p.contact||'';
      document.getElementById('address').value=p.address||'';
      document.getElementById('currency').value=p.currency||'';
      document.getElementById('signature').value=p.signature||'';
      alert('Profile loaded');
    } else { alert(res.message); }
  });
}

/* ------------------- Invoice ------------------- */
function addItemRow(){
  const tbody = document.querySelector('#itemsTable tbody');
  const idx = tbody.rows.length+1;
  const row = tbody.insertRow();
  row.innerHTML = `<td class="num">${idx}</td>
    <td><input type="text" class="iname"></td>
    <td><input type="number" class="iqty" value="1"></td>
    <td><input type="number" class="irate" value="0"></td>
    <td><input type="number" class="idiscount" value="0"></td>
    <td>
      <select class="idisctype">
        <option value="amount">Amount</option>
        <option value="percent">Percent</option>
      </select>
    </td>
    <td><button onclick="this.parentElement.parentElement.remove()">Remove</button></td>`;
}

function getInvoiceItems(){
  const tbody = document.querySelector('#itemsTable tbody');
  const items=[];
  for(let r=0;r<tbody.rows.length;r++){
    const row = tbody.rows[r];
    items.push({
      name: row.querySelector('.iname').value,
      qty: Number(row.querySelector('.iqty').value),
      rate: Number(row.querySelector('.irate').value),
      discount: Number(row.querySelector('.idiscount').value),
      discountType: row.querySelector('.idisctype').value
    });
  }
  return items;
}

function previewInvoice(){
  const invoiceObj = {
    customerName: document.getElementById('customerName').value,
    items: getInvoiceItems()
  };
  postAction('getInvoiceHtml',{email:currentEmail,invoiceObj}).then(res=>{
    if(res.success){
      document.getElementById('invoicePreview').innerHTML=res.html;
    } else { alert(res.message); }
  });
}

function generateInvoicePDF(){
  const invoiceObj = {
    customerName: document.getElementById('customerName').value,
    items: getInvoiceItems()
  };
  postAction('generateInvoicePDF',{email:currentEmail,invoiceObj}).then(res=>{
    if(res.success){
      const link = document.createElement('a');
      link.href=res.downloadUrl;
      link.target='_blank';
      link.download=res.invoiceId+'.pdf';
      link.textContent='Download PDF: '+res.invoiceId;
      document.getElementById('invoicePreview').appendChild(link);
      alert('PDF Generated');
    } else { alert(res.message); }
  });
}
</script>
</body>
</html>
